<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pegasus | Table环境变量</title>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    <script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Table环境变量 | Pegasus</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Table环境变量" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="功能目标" />
<meta property="og:description" content="功能目标" />
<meta property="og:site_name" content="Pegasus" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-19T13:39:02+00:00" />
<script type="application/ld+json">
{"url":"/administration/table-env","@type":"BlogPosting","headline":"Table环境变量","datePublished":"2020-08-19T13:39:02+00:00","dateModified":"2020-08-19T13:39:02+00:00","description":"功能目标","mainEntityOfPage":{"@type":"WebPage","@id":"/administration/table-env"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>

  <body>
    <nav class="navbar  is-primary ">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item ">
                <!-- Pegasus -->
                <img src="/assets/images/pegasus-icon.png">
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-start">
                
                
                
                <div class="navbar-item has-dropdown is-hoverable">
                    <a href="/overview"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-book"></i>
                        </span>
                        
                        <span>Documentation</span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/overview"
                            class="navbar-item ">概览</a>
                        
                        <a href="/clients"
                            class="navbar-item ">客户端库</a>
                        
                        <a href="/api"
                            class="navbar-item ">用户接口</a>
                        
                        <a href="/administration"
                            class="navbar-item ">高效运维</a>
                        
                    </div>
                </div>
                
                
                
                <a href="/blogs"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-rss"></i>
                    </span>
                    
                    <span>Blog</span>
                </a>
                
                
                
                <div class="navbar-item has-dropdown is-hoverable">
                    <a href="/community"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-user-plus"></i>
                        </span>
                        
                        <span>Community</span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/community/#联系我们"
                            class="navbar-item ">联系我们</a>
                        
                        <a href="/community/#参与贡献"
                            class="navbar-item ">参与贡献</a>
                        
                        <a href="/community/coding-guides"
                            class="navbar-item ">Coding Guides</a>
                        
                        <a href="/community/roadmap"
                            class="navbar-item ">Roadmap</a>
                        
                        <a href="https://github.com/XiaoMi/pegasus/labels/type%2Fbug"
                            class="navbar-item ">Bug Tracking</a>
                        
                        <a href="/community/proposal"
                            class="navbar-item ">Apache Proposal</a>
                        
                    </div>
                </div>
                
                
                
                <a href="https://github.com/XiaoMi/pegasus"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fab fa-github-alt"></i>
                    </span>
                    
                    <span>Github</span>
                </a>
                
                
                
                <a href="/releases"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-fire"></i>
                    </span>
                    
                    <span>Releases</span>
                </a>
                
                
                
            </div>
            <div class="navbar-end is-hidden-mobile">
                <div class="navbar-item navbar-searchbox">
                    <div class="field">
                        <div class="control has-icons-right">
                            <input class="input searchbox-input" type="text" placeholder="Search the docs">
                            <span class="border"></span>
                            <span class="icon is-right searchbox-icon">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>

<script>
    docsearch({
        appId: '50E27EHNIK',
        indexName: 'pegasus-kv',
        apiKey: '384e9a24e20ffe7cd7ffa708ceb08253',
        inputSelector: '.searchbox-input',
        debug: false,
    });

    $('.searchbox-input').focus(function () {
        $('.navbar-searchbox .border').animate({ left: '0', width: '100%' })
        $('.searchbox-icon').css({ color: 'white' })
    })
    $('.searchbox-input').focusout(function () {
        $('.navbar-searchbox .border').animate({ left: '0', width: '0' })
        $('.searchbox-icon').css({ color: 'hsl(0, 0%, 86%)' })
    })
</script>
    <section  class="hero is-bold is-primary"
     >
    <div class="hero-body" style="padding-bottom: 6rem; padding-top: 6rem;">
        <div class="container has-text-centered">
            <p class="title is-2">Table环境变量</p>
        </div>
    </div>
</section>
    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                <div class="column is-one-fourth">
                    
                    

<aside class="menu">

    <p class="menu-label"></p>
    <ul class="menu-list">
        
        <li>
            <a href="/administration" class="">高效运维</a>
            
        </li>
        
        <li>
            <a href="/administration/deployment" class="">集群部署</a>
            
        </li>
        
        <li>
            <a href="/administration/config" class="">配置说明</a>
            
        </li>
        
        <li>
            <a href="/administration/rebalance" class="">负载均衡</a>
            
        </li>
        
        <li>
            <a href="/administration/monitoring" class="">可视化监控</a>
            
        </li>
        
        <li>
            <a href="/administration/rolling-update" class="">集群升级</a>
            
        </li>
        
        <li>
            <a href="/administration/membership-change" class="">集群扩容缩容</a>
            
        </li>
        
        <li>
            <a href="/administration/resource-management" class="">资源管理</a>
            
        </li>
        
        <li>
            <a href="/administration/cold-backup" class="">冷备份</a>
            
        </li>
        
        <li>
            <a href="/administration/meta-recovery" class="">元数据恢复</a>
            
        </li>
        
        <li>
            <a href="/administration/replica-recovery" class="">Replica数据恢复</a>
            
        </li>
        
        <li>
            <a href="/administration/zk-migration" class="">Zookeeper迁移</a>
            
        </li>
        
        <li>
            <a href="/administration/table-migration" class="">Table迁移</a>
            
        </li>
        
        <li>
            <a href="/administration/table-soft-delete" class="">Table软删除</a>
            
        </li>
        
        <li>
            <a href="/administration/table-env" class="is-active">Table环境变量</a>
            
        </li>
        
        <li>
            <a href="/administration/remote-commands" class="">远程命令</a>
            
        </li>
        
        <li>
            <a href="/administration/partition-split" class="">Partition-Split</a>
            
        </li>
        
        <li>
            <a href="/administration/duplication" class="">跨机房同步</a>
            
        </li>
        
        <li>
            <a href="/administration/compression" class="">数据压缩</a>
            
        </li>
        
        <li>
            <a href="/administration/throttling" class="">流量控制</a>
            
        </li>
        
        <li>
            <a href="/administration/experiences" class="">运维经验</a>
            
        </li>
        
        <li>
            <a href="/administration/manual-compact" class="">Manual Compact功能</a>
            
        </li>
        
        <li>
            <a href="/administration/usage-scenario" class="">Usage Scenario功能</a>
            
        </li>
        
        <li>
            <a href="/administration/bad-disk" class="">坏盘检修</a>
            
        </li>
        
        <li>
            <a href="/administration/whitelist" class="">白名单</a>
            
        </li>
        
        <li>
            <a href="/administration/backup-request" class="">Backup Request</a>
            
        </li>
            
    </ul>

</aside>

                    
                </div>
                <div class="column is-half">
                    
                    <div class="content">
    <h1 id="功能目标">功能目标</h1>

<p>为了对Table的一些行为进行控制，Pegasus提供了Table环境变量，又称之为<code class="language-plaintext highlighter-rouge">app envs</code>。</p>

<p>Table环境变量以kv-map的形式存储在Table的元数据<code class="language-plaintext highlighter-rouge">app_info</code>中，并持久化到Zookeeper上。通过shell的<code class="language-plaintext highlighter-rouge">ls</code>命令查看表信息，最后一列<code class="language-plaintext highlighter-rouge">envs_count</code>记录Table环境变量的kv对个数：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; ls
app_id    status              app_name            app_type            partition_count     replica_count       is_stateful         drop_expire_time    envs_count          
1         AVAILABLE           temp                pegasus             8                   3                   true                -                   1     
</code></pre></div></div>

<p>如果要查看具体的Table环境变量，则需要使用<a href="#get_app_envs">get_app_envs</a>命令。</p>

<p>Table环境变量具有如下特性：</p>
<ul>
  <li>作为Table的元数据持久化到Zookeeper上。</li>
  <li>可以通过命令动态修改，修改成功后会立即更新到Zookeeper上。</li>
  <li>通过meta server和replica server的定期同步消息<code class="language-plaintext highlighter-rouge">config_sync</code>同步给各个replica生效。由于是定期同步，所以环境变量更新后不会立即生效，而是有一个同步过程，这个过程的时间依赖于配置文件<code class="language-plaintext highlighter-rouge">config_sync_interval_ms</code>的值，默认是30秒。</li>
  <li>环境变量的key通过都是采用<code class="language-plaintext highlighter-rouge">.</code>分隔的字段的形式，方便组织。</li>
</ul>

<p>目前通过Table环境变量支持的功能包括：</p>
<ul>
  <li><a href="manual-compact">Manual-Compact功能</a></li>
  <li><a href="usage-scenario">Usage-Scenario功能</a></li>
</ul>

<h1 id="操作命令">操作命令</h1>
<p>Pegasus的<a href="/overview/shell#set_app_envs">Shell工具</a>中提供了操作Table环境变量的命令。这些命令执行前都需要先执行<code class="language-plaintext highlighter-rouge">use xxx</code>选择表。</p>

<h2 id="get_app_envs">get_app_envs</h2>
<p>获取环境变量列表，用法：<code class="language-plaintext highlighter-rouge">get_app_envs</code></p>

<p>示例：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; use temp
OK
&gt;&gt;&gt; get_app_envs
get app envs succeed, count = 1
=================================
rocksdb.usage_scenario = normal
=================================
</code></pre></div></div>
<h2 id="set_app_envs">set_app_envs</h2>
<p>设置环境变量，用法：<code class="language-plaintext highlighter-rouge">set_app_envs &lt;key&gt; &lt;value&gt; [key value...]</code></p>

<p>示例：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; use temp
OK
&gt;&gt;&gt; set_app_envs rocksdb.usage_scenario bulk_load
set app envs succeed
&gt;&gt;&gt; get_app_envs
get app envs succeed, count = 1
=================================
rocksdb.usage_scenario = bulk_load
=================================
</code></pre></div></div>

<h2 id="del_app_envs">del_app_envs</h2>
<p>删除环境变量，用法：<code class="language-plaintext highlighter-rouge">del_app_envs &lt;key&gt; [key...]</code></p>

<p>示例：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; use temp
OK
&gt;&gt;&gt; del_app_envs rocksdb.usage_scenario
del app envs succeed
=============================
deleted keys:
    rocksdb.usage_scenario
=============================
&gt;&gt;&gt; get_app_envs
get app envs succeed, count = 0
</code></pre></div></div>

<h2 id="clear_app_envs">clear_app_envs</h2>
<p>清理环境变量，或者叫批量删除环境变量，用法：<code class="language-plaintext highlighter-rouge">clear_app_envs &lt;-a|--all&gt; &lt;-p|--prefix str&gt;</code></p>

<p>两种方式：</p>
<ul>
  <li>全部清理：使用<code class="language-plaintext highlighter-rouge">-a</code>选项。</li>
  <li>通过前缀清理：使用<code class="language-plaintext highlighter-rouge">-p</code>选项指定前缀，匹配时会先自动在前缀后面加上<code class="language-plaintext highlighter-rouge">.</code>，然后按照字符串前缀匹配。</li>
</ul>

<p>譬如：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; use temp
OK
&gt;&gt;&gt; set_app_envs k.x v1 k.y v2
set app envs succeed
&gt;&gt;&gt; get_app_envs
get app envs succeed, count = 2
=================================
k.x = v1
k.y = v2
=================================
&gt;&gt;&gt; clear_app_envs -p k
clear app envs succeed
=============================
deleted keys:
    k.x
    k.y
=============================
&gt;&gt;&gt; get_app_envs
get app envs succeed, count = 0
</code></pre></div></div>

<h1 id="支持列表">支持列表</h1>

<table>
  <thead>
    <tr>
      <th>key名称</th>
      <th>value类型</th>
      <th>value约束</th>
      <th>value示例</th>
      <th>功能说明</th>
      <th>支持版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>rocksdb.usage_scenario</td>
      <td>string</td>
      <td>normal | prefer_write | bulk_load</td>
      <td>bulk_load</td>
      <td><a href="usage-scenario">Usage-Scenario</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>replica.deny_client_write</td>
      <td>bool</td>
      <td>true | false</td>
      <td>true</td>
      <td>拒绝写请求</td>
      <td>1.11.2</td>
    </tr>
    <tr>
      <td>replica.write_throttling</td>
      <td>string</td>
      <td>特定格式</td>
      <td>1000*delay*100</td>
      <td><a href="throttling#表级流控">流量控制#表级流控</a></td>
      <td>1.11.2</td>
    </tr>
    <tr>
      <td>replica.write_throttling_by_size</td>
      <td>string</td>
      <td>特定格式</td>
      <td>1000*delay*100</td>
      <td><a href="throttling#表级流控">流量控制#表级流控</a></td>
      <td>1.12.0</td>
    </tr>
    <tr>
      <td>default_ttl</td>
      <td>int</td>
      <td>&gt;=0</td>
      <td>86400</td>
      <td><a href="/api/ttl#表级TTL">表级TTL</a></td>
      <td>1.11.2</td>
    </tr>
    <tr>
      <td>manual_compact.disabled</td>
      <td>bool</td>
      <td>true | false</td>
      <td>true</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.9.0</td>
    </tr>
    <tr>
      <td>manual_compact.max_concurrent_running_count</td>
      <td>int</td>
      <td>&gt;=0</td>
      <td>10</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.11.3</td>
    </tr>
    <tr>
      <td>manual_compact.once.trigger_time</td>
      <td>int</td>
      <td>Unix Timestamp in Seconds</td>
      <td>1547091115</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>manual_compact.once.target_level</td>
      <td>int</td>
      <td>-1 | &gt;=1</td>
      <td>2</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>manual_compact.once.bottommost_level_compaction</td>
      <td>string</td>
      <td>force | skip</td>
      <td>force</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>manual_compact.periodic.trigger_time</td>
      <td>string</td>
      <td>特定格式</td>
      <td>3:00,5:00</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>manual_compact.periodic.target_level</td>
      <td>int</td>
      <td>-1 | &gt;=1</td>
      <td>2</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>manual_compact.periodic.bottommost_level_compaction</td>
      <td>string</td>
      <td>force | skip</td>
      <td>force</td>
      <td><a href="manual-compact">Manual-Compact</a></td>
      <td>1.8.1</td>
    </tr>
    <tr>
      <td>rocksdb.checkpoint.reserve_min_count</td>
      <td>int</td>
      <td>&gt;=1</td>
      <td>2</td>
      <td><a href="resource-management#rocksdb-checkpoint管理">Rocksdb-Checkpoint管理</a></td>
      <td>1.11.3</td>
    </tr>
    <tr>
      <td>rocksdb.checkpoint.reserve_time_seconds</td>
      <td>int</td>
      <td>&gt;=0</td>
      <td>600</td>
      <td><a href="resource-management#rocksdb-checkpoint管理">Rocksdb-Checkpoint管理</a></td>
      <td>1.11.3</td>
    </tr>
    <tr>
      <td>business.info</td>
      <td>string</td>
      <td>特定格式(使用utf-8编码)</td>
      <td>depart=云平台部-存储平台,user=qinzuoyan&amp;wutao1</td>
      <td>记录表的业务归属信息，可用于生成账单</td>
      <td>-</td>
    </tr>
    <tr>
      <td>replica.slow_query_threshold</td>
      <td>int</td>
      <td>&gt;=20</td>
      <td>30</td>
      <td>慢查询阈值</td>
      <td>1.12.0</td>
    </tr>
  </tbody>
</table>

</div>
                </div>
                
                <div class="column is-one-fourth is-hidden-mobile" style="padding-left: 3rem">
                    
                    <p class="menu-label">
                        <span class="icon">
                            <i class="fa fa-bars" aria-hidden="true"></i>
                        </span>
                        本页导航
                    </p>
                    <ul class="menu-list">
  <li><a href="#功能目标">功能目标</a></li>
  <li><a href="#操作命令">操作命令</a>
    <ul>
      <li><a href="#get_app_envs">get_app_envs</a></li>
      <li><a href="#set_app_envs">set_app_envs</a></li>
      <li><a href="#del_app_envs">del_app_envs</a></li>
      <li><a href="#clear_app_envs">clear_app_envs</a></li>
    </ul>
  </li>
  <li><a href="#支持列表">支持列表</a></li>
</ul>

                    
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="content is-small has-text-centered">
            <div style="margin-bottom: 20px;">
                <a href="http://incubator.apache.org"><img src="/assets/images/egg-logo.png"
                                                           alt="Apache Incubator"/></a>
            </div>
            Copyright &copy; 2020 <a href="http://www.apache.org">The Apache Software Foundation</a>.
            Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version
            2.0</a>.
            <br><br>
            
            Apache Pegasus is an effort undergoing incubation at The Apache Software Foundation (ASF),
            sponsored by the Apache Incubator. Incubation is required of all newly accepted projects
            until a further review indicates that the infrastructure, communications, and decision making process
            have stabilized in a manner consistent with other successful ASF projects. While incubation status is
            not necessarily a reflection of the completeness or stability of the code, it does indicate that the
            project has yet to be fully endorsed by the ASF.
            
        </div>
    </div>
</footer>
    <script src="/assets/js/app.js" type="text/javascript"></script>
  </body>
</html>
