<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pegasus | 远程命令</title>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    <script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>远程命令 | Pegasus</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="远程命令" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="功能目标" />
<meta property="og:description" content="功能目标" />
<meta property="og:site_name" content="Pegasus" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-19T13:44:03+00:00" />
<script type="application/ld+json">
{"url":"/administration/remote-commands","@type":"BlogPosting","headline":"远程命令","datePublished":"2020-08-19T13:44:03+00:00","dateModified":"2020-08-19T13:44:03+00:00","description":"功能目标","mainEntityOfPage":{"@type":"WebPage","@id":"/administration/remote-commands"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>

  <body>
    <nav class="navbar  is-primary ">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item ">
                <!-- Pegasus -->
                <img src="/assets/images/pegasus-icon.png">
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-start">
                
                
                
                <div class="navbar-item has-dropdown is-hoverable">
                    <a href="/overview"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-book"></i>
                        </span>
                        
                        <span>Documentation</span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/overview"
                            class="navbar-item ">概览</a>
                        
                        <a href="/clients"
                            class="navbar-item ">客户端库</a>
                        
                        <a href="/api"
                            class="navbar-item ">用户接口</a>
                        
                        <a href="/administration"
                            class="navbar-item ">高效运维</a>
                        
                    </div>
                </div>
                
                
                
                <a href="/blogs"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-rss"></i>
                    </span>
                    
                    <span>Blog</span>
                </a>
                
                
                
                <div class="navbar-item has-dropdown is-hoverable">
                    <a href="/community"
                        class="navbar-link ">
                        
                        <span class="icon" style="margin-right: .25em">
                            <i class="fas fa-user-plus"></i>
                        </span>
                        
                        <span>Community</span>
                    </a>
                    <div class="navbar-dropdown">
                        
                        <a href="/community/#联系我们"
                            class="navbar-item ">联系我们</a>
                        
                        <a href="/community/#参与贡献"
                            class="navbar-item ">参与贡献</a>
                        
                        <a href="/community/coding-guides"
                            class="navbar-item ">Coding Guides</a>
                        
                        <a href="/community/roadmap"
                            class="navbar-item ">Roadmap</a>
                        
                        <a href="https://github.com/XiaoMi/pegasus/labels/type%2Fbug"
                            class="navbar-item ">Bug Tracking</a>
                        
                        <a href="/community/proposal"
                            class="navbar-item ">Apache Proposal</a>
                        
                    </div>
                </div>
                
                
                
                <a href="https://github.com/XiaoMi/pegasus"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fab fa-github-alt"></i>
                    </span>
                    
                    <span>Github</span>
                </a>
                
                
                
                <a href="/releases"
                    class="navbar-item ">
                    
                    <span class="icon" style="margin-right: .25em">
                        <i class="fas fa-fire"></i>
                    </span>
                    
                    <span>Releases</span>
                </a>
                
                
                
            </div>
            <div class="navbar-end is-hidden-mobile">
                <div class="navbar-item navbar-searchbox">
                    <div class="field">
                        <div class="control has-icons-right">
                            <input class="input searchbox-input" type="text" placeholder="Search the docs">
                            <span class="border"></span>
                            <span class="icon is-right searchbox-icon">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>

<script>
    docsearch({
        appId: '50E27EHNIK',
        indexName: 'pegasus-kv',
        apiKey: '384e9a24e20ffe7cd7ffa708ceb08253',
        inputSelector: '.searchbox-input',
        debug: false,
    });

    $('.searchbox-input').focus(function () {
        $('.navbar-searchbox .border').animate({ left: '0', width: '100%' })
        $('.searchbox-icon').css({ color: 'white' })
    })
    $('.searchbox-input').focusout(function () {
        $('.navbar-searchbox .border').animate({ left: '0', width: '0' })
        $('.searchbox-icon').css({ color: 'hsl(0, 0%, 86%)' })
    })
</script>
    <section  class="hero is-bold is-primary"
     >
    <div class="hero-body" style="padding-bottom: 6rem; padding-top: 6rem;">
        <div class="container has-text-centered">
            <p class="title is-2">远程命令</p>
        </div>
    </div>
</section>
    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                <div class="column is-one-fourth">
                    
                    

<aside class="menu">

    <p class="menu-label"></p>
    <ul class="menu-list">
        
        <li>
            <a href="/administration" class="">高效运维</a>
            
        </li>
        
        <li>
            <a href="/administration/deployment" class="">集群部署</a>
            
        </li>
        
        <li>
            <a href="/administration/config" class="">配置说明</a>
            
        </li>
        
        <li>
            <a href="/administration/rebalance" class="">负载均衡</a>
            
        </li>
        
        <li>
            <a href="/administration/monitoring" class="">可视化监控</a>
            
        </li>
        
        <li>
            <a href="/administration/rolling-update" class="">集群升级</a>
            
        </li>
        
        <li>
            <a href="/administration/membership-change" class="">集群扩容缩容</a>
            
        </li>
        
        <li>
            <a href="/administration/resource-management" class="">资源管理</a>
            
        </li>
        
        <li>
            <a href="/administration/cold-backup" class="">冷备份</a>
            
        </li>
        
        <li>
            <a href="/administration/meta-recovery" class="">元数据恢复</a>
            
        </li>
        
        <li>
            <a href="/administration/replica-recovery" class="">Replica数据恢复</a>
            
        </li>
        
        <li>
            <a href="/administration/zk-migration" class="">Zookeeper迁移</a>
            
        </li>
        
        <li>
            <a href="/administration/table-migration" class="">Table迁移</a>
            
        </li>
        
        <li>
            <a href="/administration/table-soft-delete" class="">Table软删除</a>
            
        </li>
        
        <li>
            <a href="/administration/table-env" class="">Table环境变量</a>
            
        </li>
        
        <li>
            <a href="/administration/remote-commands" class="is-active">远程命令</a>
            
        </li>
        
        <li>
            <a href="/administration/partition-split" class="">Partition-Split</a>
            
        </li>
        
        <li>
            <a href="/administration/duplication" class="">跨机房同步</a>
            
        </li>
        
        <li>
            <a href="/administration/compression" class="">数据压缩</a>
            
        </li>
        
        <li>
            <a href="/administration/throttling" class="">流量控制</a>
            
        </li>
        
        <li>
            <a href="/administration/experiences" class="">运维经验</a>
            
        </li>
        
        <li>
            <a href="/administration/manual-compact" class="">Manual Compact功能</a>
            
        </li>
        
        <li>
            <a href="/administration/usage-scenario" class="">Usage Scenario功能</a>
            
        </li>
        
        <li>
            <a href="/administration/bad-disk" class="">坏盘检修</a>
            
        </li>
        
        <li>
            <a href="/administration/whitelist" class="">白名单</a>
            
        </li>
        
        <li>
            <a href="/administration/backup-request" class="">Backup Request</a>
            
        </li>
            
    </ul>

</aside>

                    
                </div>
                <div class="column is-half">
                    
                    <div class="content">
    <h1 id="功能目标">功能目标</h1>

<p>Pegasus基于rDSN框架构建，可以利用到rDSN框架的很多有用的功能，远程命令就是其中一个。</p>

<p>rDSN框架通过RPC对外提供服务，除了开发者注册的用于业务逻辑的RPC服务，还提供了内建的RPC服务<code class="language-plaintext highlighter-rouge">RPC_CLI_CLI_CALL</code>，接口定义如下：</p>
<pre><code class="language-idl">struct command
{
    1:string       cmd;
    2:list&lt;string&gt; arguments;
}

service cli
{
    string call(1:command c);
}
</code></pre>
<p>RPC的请求参数为command结构体，指定远程命令的<code class="language-plaintext highlighter-rouge">cmd</code>和<code class="language-plaintext highlighter-rouge">arguments</code>；RPC的返回结果是<code class="language-plaintext highlighter-rouge">string</code>。</p>

<p>开发者可以注册各种远程命令，对远程命令处理并返回结果。你可以通过shell的<code class="language-plaintext highlighter-rouge">remote_command</code>接口向Pegasus的进程发送远程命令，以执行某些操作。</p>

<p>通过远程命令执行操作有这些好处：</p>
<ul>
  <li>直接。命令直接发给目标进程。</li>
  <li>快速生效。命令一般都是立即执行。</li>
  <li>开发简单。注册和开发过程都很容易。</li>
</ul>

<h1 id="支持命令">支持命令</h1>

<p>Pegasus不同角色的进程支持不同的远程命令。但是collector没有监听端口，所以不支持远程命令。</p>

<h2 id="rdsn内建命令">rdsn内建命令</h2>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>engine</td>
      <td>获取rdsn框架引擎的信息，主要是包含哪些线程池、每个线程池有多少个线程</td>
    </tr>
    <tr>
      <td>system.queue</td>
      <td>获取各线程池执行队列的排队长度</td>
    </tr>
    <tr>
      <td>server-info</td>
      <td>获取进程的基本信息，包括版本号、启动时间，对应shell的<code class="language-plaintext highlighter-rouge">server_info</code>子命令</td>
    </tr>
    <tr>
      <td>server-stat</td>
      <td>获取进程的简要统计信息，包括get/put等操作的QPS和延迟、机器的内存和存储使用情况，对应shell的<code class="language-plaintext highlighter-rouge">server_stat</code>子命令</td>
    </tr>
    <tr>
      <td>task-code</td>
      <td>获取该进程注册的task code列表</td>
    </tr>
    <tr>
      <td>flush_log</td>
      <td>将最近缓冲区中的日志数据刷出到日志文件中，对应shell的<code class="language-plaintext highlighter-rouge">flush_log</code>子命令</td>
    </tr>
    <tr>
      <td>reset-log-start-level</td>
      <td>动态修改日志的级别</td>
    </tr>
    <tr>
      <td>perf-counters</td>
      <td>获取最近一个统计周期内的perf counter数据</td>
    </tr>
    <tr>
      <td>config-dump</td>
      <td>获取该进程启动时的配置文件的信息</td>
    </tr>
  </tbody>
</table>

<h2 id="meta-server">meta-server</h2>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>meta.lb.assign_delay_ms</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">replica_assign_delay_ms_for_dropouts</code></td>
    </tr>
    <tr>
      <td>meta.lb.assign_secondary_black_list</td>
      <td>动态修改<code class="language-plaintext highlighter-rouge">add_secondary</code>操作的黑名单，名单中的节点在负载均衡中不再分派replica</td>
    </tr>
    <tr>
      <td>meta.lb.balancer_in_turn</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">balancer_in_turn</code>，控制负载均衡app时是one-by-one执行还是并行执行</td>
    </tr>
    <tr>
      <td>meta.lb.only_primary_balancer</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">only_primary_balancer</code>，控制负载均衡时是否只要求各机器的primary replica个数达到平衡</td>
    </tr>
    <tr>
      <td>meta.lb.only_move_primary</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">only_move_primary</code>，控制负载均衡时是否只做primary replica迁移，不做replica数据拷贝</td>
    </tr>
    <tr>
      <td>meta.lb.add_secondary_enable_flow_control</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">add_secondary_enable_flow_control</code>，控制负载均衡时是否对<code class="language-plaintext highlighter-rouge">add_secondary</code>操作进行流控</td>
    </tr>
    <tr>
      <td>meta.lb.add_secondary_max_count_for_one_node</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">add_secondary_max_count_for_one_node</code>，控制负载均衡时如果进行流控，单个机器最多并发执行<code class="language-plaintext highlighter-rouge">add_secondary</code>操作的个数</td>
    </tr>
  </tbody>
</table>

<h2 id="replica-server">replica-server</h2>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>replica.kill_partition</td>
      <td>将指定的replica关闭，停止提供服务</td>
    </tr>
    <tr>
      <td>replica.deny-client</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">deny_client_on_start</code>，控制是否拒绝客户端的读写请求</td>
    </tr>
    <tr>
      <td>replica.verbose-client-log</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">verbose_client_log_on_start</code>，控制回复客户端的请求时是否打印ERROR日志</td>
    </tr>
    <tr>
      <td>replica.verbose-commit-log</td>
      <td>动态修改配置<code class="language-plaintext highlighter-rouge">verbose_commit_log_on_start</code>，控制在提交写请求时是否打印DEBUG日志</td>
    </tr>
    <tr>
      <td>replica.trigger-checkpoint</td>
      <td>对指定的replica手动触发<code class="language-plaintext highlighter-rouge">async_checkpoint</code>操作</td>
    </tr>
    <tr>
      <td>replica.query-compact</td>
      <td>对指定的replica查询其执行<a href="manual-compact">Manual-Compact</a>操作的状态</td>
    </tr>
    <tr>
      <td>replica.query-app-envs</td>
      <td>对指定的replica查询其当前的<a href="table-env">Table环境变量</a></td>
    </tr>
    <tr>
      <td>useless-dir-reserve-seconds</td>
      <td>动态修改无用文件夹的保留时间，方便快速释放存储空间，从<a href="https://github.com/XiaoMi/pegasus/releases/tag/v1.11.3">1.11.3版本</a>开始支持，参见<a href="#resource-management#垃圾文件夹管理">垃圾文件夹管理</a></td>
    </tr>
  </tbody>
</table>

<h1 id="如何使用">如何使用</h1>

<p>通过shell的<code class="language-plaintext highlighter-rouge">remote_command</code>子命令，可以向指定的一个或者多个进程发送远程命令。用法：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USAGE:  remote_command         [-t all|meta-server|replica-server] [-l ip:port,ip:port...] &lt;command&gt;
                               [arguments...]
</code></pre></div></div>
<p>其中需要通过<code class="language-plaintext highlighter-rouge">-t</code>或者<code class="language-plaintext highlighter-rouge">-l</code>来指定目标进程：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">-t</code>：只向指定角色的所有进程发送。</li>
  <li><code class="language-plaintext highlighter-rouge">-l</code>：只向指定的地址发送，可以通过列表指定多个地址。</li>
</ul>

<p>如果你不知道目标进程支持哪些远程命令，可以发送<code class="language-plaintext highlighter-rouge">help</code>命令查看，譬如：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; remote_command -l 127.0.0.1:34801 help
COMMAND: help

CALL [user-specified] [127.0.0.1:34801] succeed: help|Help|h|H [command] - display help information
repeat|Repeat|r|R interval_seconds max_count command - execute command periodically
engine - get engine internal information
system.queue - get queue internal information
server-info - query server information
server-stat - query selected perf counters
task-code - query task code containing any given keywords
flush-log - flush log to stderr or log file
reset-log-start-level - reset the log start level
perf-counters - query perf counters, supporting filter by POSIX basic regular expressions
profile|Profile|p|P - performance profiling
profiler data - get appointed data, using by pjs
profiler.query|pq - query profiling data, output in json format
config-dump - dump configuration
replica.kill_partition [app_id [partition_index]]
replica.deny-client &lt;true|false&gt;
replica.verbose-client-log &lt;true|false&gt;
replica.verbose-commit-log &lt;true|false&gt;
replica.trigger-checkpoint [id1,id2,...] (where id is 'app_id' or 'app_id.partition_id')
replica.query-compact [id1,id2,...] (where id is 'app_id' or 'app_id.partition_id')
replica.query-app-envs [id1,id2,...] (where id is 'app_id' or 'app_id.partition_id')


Succeed count: 1
Failed count: 0
</code></pre></div></div>

<p>如果指定多个进程，就会并发地向所有进程发送命令，等待命令的返回结果，然后打印出来。</p>

</div>
                </div>
                
                <div class="column is-one-fourth is-hidden-mobile" style="padding-left: 3rem">
                    
                    <p class="menu-label">
                        <span class="icon">
                            <i class="fa fa-bars" aria-hidden="true"></i>
                        </span>
                        本页导航
                    </p>
                    <ul class="menu-list">
  <li><a href="#功能目标">功能目标</a></li>
  <li><a href="#支持命令">支持命令</a>
    <ul>
      <li><a href="#rdsn内建命令">rdsn内建命令</a></li>
      <li><a href="#meta-server">meta-server</a></li>
      <li><a href="#replica-server">replica-server</a></li>
    </ul>
  </li>
  <li><a href="#如何使用">如何使用</a></li>
</ul>

                    
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="content is-small has-text-centered">
            <div style="margin-bottom: 20px;">
                <a href="http://incubator.apache.org"><img src="/assets/images/egg-logo.png"
                                                           alt="Apache Incubator"/></a>
            </div>
            Copyright &copy; 2020 <a href="http://www.apache.org">The Apache Software Foundation</a>.
            Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version
            2.0</a>.
            <br><br>
            
            Apache Pegasus is an effort undergoing incubation at The Apache Software Foundation (ASF),
            sponsored by the Apache Incubator. Incubation is required of all newly accepted projects
            until a further review indicates that the infrastructure, communications, and decision making process
            have stabilized in a manner consistent with other successful ASF projects. While incubation status is
            not necessarily a reflection of the completeness or stability of the code, it does indicate that the
            project has yet to be fully endorsed by the ASF.
            
        </div>
    </div>
</footer>
    <script src="/assets/js/app.js" type="text/javascript"></script>
  </body>
</html>
